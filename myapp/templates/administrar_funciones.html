{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Funciones</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles/funciones.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">

<div class="container mt-4 mb-5">
    <h1 class="text-center mb-4"><i class="fas fa-calendar-alt"></i> Administrar Funciones</h1>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="mb-3 d-flex gap-2">
        <a href="{% url 'index' %}" class="btn btn-primary"><i class="fas fa-home"></i> Volver al Inicio</a>
        <a href="{% url 'peliculas' %}" class="btn btn-primary"><i class="fas fa-film"></i> Administrar Pel√≠culas</a>
    </div>

    <!-- Formulario Crear / Editar -->
    <div class="card shadow-sm">
        <div class="card-header {% if funcion_editar %}bg-warning{% else %}bg-success{% endif %} text-white">
            {% if funcion_editar %}‚úèÔ∏è Editar Funci√≥n{% else %}üé• Agregar Nueva Funci√≥n{% endif %}
        </div>
        <div class="card-body">
            <form method="POST" action="{% url 'administrar_funciones' %}" id="funcionForm">
                {% csrf_token %}
                <input type="hidden" name="accion" value="{% if funcion_editar %}editar{% else %}agregar{% endif %}">
                {% if funcion_editar %}
                    <input type="hidden" name="funcion_id" value="{{ funcion_editar.id }}">
                {% endif %}

                <div class="row g-3">
                    <!-- Pel√≠cula -->
                    <div class="col-md-6">
                        <label class="form-label">Pel√≠cula</label>
                        <select name="pelicula" class="form-select" id="peliculaSelect" required>
                            <option value="">-- Selecciona una pel√≠cula --</option>
                            {% for p in peliculas %}
                                <option value="{{ p.id }}"
                                    data-salas="{% for sala, formato in p.get_salas_con_formato %}{{ sala }} - {{ formato }};{% endfor %}"
                                    {% if funcion_editar and funcion_editar.pelicula.id == p.id %}selected{% endif %}>
                                    {{ p.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Fecha de inicio -->
                    <div class="col-md-3">
                        <label class="form-label">Fecha de inicio</label>
                        <input type="date" name="fecha_inicio" id="fechaInput" class="form-control"
                               min="{{ hoy_es|date:'Y-m-d' }}"
                               value="{% if funcion_editar %}{{ funcion_editar.fecha_inicio|date:'Y-m-d' }}{% endif %}"
                               required>
                    </div>

                    <!-- Semanas -->
                    <div class="col-md-3">
                        <label class="form-label">Semanas en cartelera</label>
                        <select name="semanas" class="form-select" required>
                            {% for n in "12345678"|make_list %}
                                <option value="{{ n }}"
                                    {% if funcion_editar and funcion_editar.semanas == n|add:"0" %}selected{% endif %}>
                                    {{ n }} semana{% if n != '1' %}s{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Secci√≥n de Horarios M√∫ltiples -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Horarios y Salas</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="agregarHorario">
                            <i class="fas fa-plus"></i> Agregar Horario
                        </button>
                    </div>
                    
                    <div id="horariosContainer">
                        <div class="horario-item">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Horario</label>
                                    <select name="horario[]" class="form-select" required>
                                        <option value="">-- Selecciona horario --</option>
                                        {% for h, label in HORARIOS_DISPONIBLES %}
                                            <option value="{{ h }}"
                                                {% if funcion_editar and funcion_editar.horario == h %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Sala / Formato</label>
                                    <select name="sala[]" class="form-select sala-select" required>
                                        <option value="">-- Selecciona una sala --</option>
                                        {% if funcion_editar %}
                                            {% for sala, formato in funcion_editar.pelicula.get_salas_con_formato %}
                                                <option value="{{ sala }}"
                                                    {% if funcion_editar.sala == sala %}selected{% endif %}>
                                                    {{ sala }} - {{ formato }}
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger remove-horario" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        <i class="fas fa-info-circle"></i> Puede agregar m√∫ltiples horarios para la misma pel√≠cula
                    </div>
                </div>

                <div class="mt-4 text-center">
                    {% if funcion_editar %}
                        <button type="submit" class="btn btn-warning px-4"><i class="fas fa-save"></i> Guardar Cambios</button>
                        <a href="{% url 'administrar_funciones' %}" class="btn btn-secondary px-4">Cancelar</a>
                    {% else %}
                        <button type="submit" class="btn btn-success px-4"><i class="fas fa-plus"></i> Agregar Funciones</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de funciones vigentes -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-dark text-white">üéûÔ∏è Funciones Vigentes</div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Pel√≠cula</th>
                        <th>Inicio</th>
                        <th>Duraci√≥n</th>
                        <th>Finalizaci√≥n</th>
                        <th>Horarios y Salas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% regroup funciones_actuales by pelicula.id as peliculas_funciones %}
                    {% for pelicula_grupo in peliculas_funciones %}
                        {% with pelicula_grupo.list.0.pelicula as pelicula %}
                        <tr class="funcion-combinada">
                            <td>
                                {% if pelicula.imagen_url %}
                                    <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="img-thumbnail" style="width:60px; height:80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary d-flex align-items-center justify-content-center img-thumbnail" style="width:60px; height:80px;">
                                        <i class="fas fa-film text-white"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td><strong>{{ pelicula.nombre }}</strong></td>
                            <td>{{ pelicula_grupo.list.0.fecha_inicio|date:"d/m/Y" }}</td>
                            <td>
                                {% for funcion in pelicula_grupo.list %}
                                    {{ funcion.semanas }} semana{{ funcion.semanas|pluralize }}
                                    {% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </td>
                            <td>{{ pelicula_grupo.list.0.fecha_fin|date:"d/m/Y" }}</td>
                            <td>
                                <div class="horarios-container">
                                    {% for funcion in pelicula_grupo.list %}
                                        <div class="horario-item mb-1">
                                            {{ funcion.get_horario_display }} - {{ funcion.sala }} - {{ funcion.get_formato_sala }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% for funcion in pelicula_grupo.list %}
                                        <div class="d-flex gap-1 mb-1">
                                            <a href="?editar={{ funcion.id }}" class="btn btn-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm"
                                                    data-bs-toggle="modal" data-bs-target="#modalEliminar{{ funcion.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-calendar-times fa-2x mb-2"></i><br>
                                No hay funciones vigentes
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modales de Eliminaci√≥n -->
    {% regroup funciones_actuales by pelicula.id as peliculas_funciones %}
    {% for pelicula_grupo in peliculas_funciones %}
        {% for funcion in pelicula_grupo.list %}
        <div class="modal fade" id="modalEliminar{{ funcion.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci√≥n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="fs-5">¬øEst√°s seguro de que deseas eliminar esta funci√≥n?</p>
                        <p class="text-muted mb-0">
                            <strong>{{ funcion.pelicula.nombre }}</strong><br>
                            {{ funcion.fecha_inicio|date:"d/m/Y" }} - {{ funcion.get_horario_display }} - {{ funcion.sala }} - {{ funcion.get_formato_sala }}
                        </p>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <form method="POST" action="{% url 'administrar_funciones' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="eliminar">
                            <input type="hidden" name="funcion_id" value="{{ funcion.id }}">
                            <button type="submit" class="btn btn-danger px-4">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endfor %}

    <!-- Tabla de funciones pasadas -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-secondary text-white">üìú Funciones Pasadas</div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Pel√≠cula</th>
                        <th>Inicio</th>
                        <th>Duraci√≥n</th>
                        <th>Finalizaci√≥n</th>
                        <th>Horarios y Salas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% regroup funciones_pasadas by pelicula.id as peliculas_funciones_pasadas %}
                    {% for pelicula_grupo in peliculas_funciones_pasadas %}
                        {% with pelicula_grupo.list.0.pelicula as pelicula %}
                        <tr class="funcion-combinada">
                            <td>
                                {% if pelicula.imagen_url %}
                                    <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="img-thumbnail" style="width:60px; height:80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary d-flex align-items-center justify-content-center img-thumbnail" style="width:60px; height:80px;">
                                        <i class="fas fa-film text-white"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td>{{ pelicula.nombre }}</td>
                            <td>{{ pelicula_grupo.list.0.fecha_inicio|date:"d/m/Y" }}</td>
                            <td>
                                {% for funcion in pelicula_grupo.list %}
                                    {% if funcion.activa %}
                                        {{ funcion.semanas }} semana{{ funcion.semanas|pluralize }}
                                    {% else %}
                                        {{ funcion.get_duracion_real }} d√≠a{{ funcion.get_duracion_real|pluralize }}
                                    {% endif %}
                                    {% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </td>
                            <td>{{ pelicula_grupo.list.0.fecha_fin|date:"d/m/Y" }}</td>
                            <td>
                                <div class="horarios-container">
                                    {% for funcion in pelicula_grupo.list %}
                                        <div class="horario-item mb-1">
                                            {{ funcion.get_horario_display }} - {{ funcion.sala }} - {{ funcion.get_formato_sala }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% for funcion in pelicula_grupo.list %}
                                        <div class="mb-1">
                                            <button type="button" class="btn btn-success btn-sm"
                                                    data-bs-toggle="modal" data-bs-target="#modalReactivar{{ funcion.id }}"
                                                    title="Reactivar funci√≥n">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-history fa-2x mb-2"></i><br>
                                No hay funciones pasadas
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modales de Reactivaci√≥n -->
    {% regroup funciones_pasadas by pelicula.id as peliculas_funciones_pasadas %}
    {% for pelicula_grupo in peliculas_funciones_pasadas %}
        {% for funcion in pelicula_grupo.list %}
        <div class="modal fade" id="modalReactivar{{ funcion.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-redo"></i> Confirmar Reactivaci√≥n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="fs-5">¬øDeseas reactivar esta funci√≥n?</p>
                        <p class="text-muted mb-0">
                            <strong>{{ funcion.pelicula.nombre }}</strong><br>
                            {{ funcion.fecha_inicio|date:"d/m/Y" }} - {{ funcion.get_horario_display }} - {{ funcion.sala }} - {{ funcion.get_formato_sala }}
                        </p>
                        <div class="alert alert-info mt-3 text-start">
                            <i class="fas fa-info-circle"></i> La funci√≥n volver√° a estar activa con sus fechas originales.
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <form method="POST" action="{% url 'administrar_funciones' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="reactivar">
                            <input type="hidden" name="funcion_id" value="{{ funcion.id }}">
                            <button type="submit" class="btn btn-success px-4">
                                <i class="fas fa-redo"></i> Reactivar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endfor %}
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/funciones.js' %}"></script>
</body>
</html>