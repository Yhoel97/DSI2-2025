{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Funciones</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles/funciones.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">

<div class="container mt-4 mb-5">
    <h1 class="text-center mb-4"><i class="fas fa-calendar-alt"></i> Administrar Funciones</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="mb-3 d-flex gap-2">
        <a href="{% url 'index' %}" class="btn btn-primary"><i class="fas fa-home"></i> Volver al Inicio</a>
        <a href="{% url 'peliculas' %}" class="btn btn-primary"><i class="fas fa-film"></i> Administrar Pel√≠culas</a>
    </div>

    <!-- Formulario Crear / Editar -->
    <div class="card shadow-sm">
        <div class="card-header {% if funcion_editar %}bg-warning{% else %}bg-success{% endif %} text-white">
            {% if funcion_editar %}‚úèÔ∏è Editar Funci√≥n{% else %}üé• Agregar Nueva Funci√≥n{% endif %}
        </div>
        <div class="card-body">
            <form method="POST" action="{% url 'administrar_funciones' %}" id="funcionForm">
                {% csrf_token %}
                <input type="hidden" name="accion" value="{% if funcion_editar %}editar{% else %}agregar{% endif %}">
                {% if funcion_editar %}
                    <input type="hidden" name="funcion_id" value="{{ funcion_editar.id }}">
                {% endif %}

                <div class="row g-3">
                    <!-- Pel√≠cula -->
                    <div class="col-md-6">
                        <label class="form-label">Pel√≠cula</label>
                        <select name="pelicula" class="form-select" id="peliculaSelect" 
                                {% if not funcion_editar %}required{% endif %}>
                            <option value="">-- Selecciona una pel√≠cula --</option>
                            {% for p in peliculas %}
                                <option value="{{ p.id }}"
                                    data-salas="{% for sala, formato in p.get_salas_con_formato %}{{ sala }} - {{ formato }};{% endfor %}"
                                    {% if funcion_editar and funcion_editar.pelicula.id == p.id %}selected{% endif %}>
                                    {{ p.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if funcion_editar %}
                            <small class="text-muted">Actual: {{ funcion_editar.pelicula.nombre }}</small>
                        {% endif %}
                    </div>

                    <!-- Fecha de inicio -->
                    <div class="col-md-3">
                        <label class="form-label">Fecha de inicio</label>
                        <input type="date" name="fecha_inicio" id="fechaInput" class="form-control"
                            {% if not funcion_editar %}
                            min="{{ hoy_es|date:'Y-m-d' }}"
                            {% endif %}
                            value="{% if funcion_editar %}{{ funcion_editar.fecha_inicio|date:'Y-m-d' }}{% endif %}"
                            {% if not funcion_editar %}required{% endif %}>
                        {% if funcion_editar %}
                            <small class="text-muted">Actual: {{ funcion_editar.fecha_inicio|date:'d/m/Y' }}</small>
                        {% endif %}
                    </div>

                    <!-- Semanas -->
                    <div class="col-md-3">
                        <label class="form-label">Semanas en cartelera</label>
                        <select name="semanas" class="form-select" {% if not funcion_editar %}required{% endif %}>
                            {% for n in "12345678"|make_list %}
                                <option value="{{ n }}"
                                    {% if funcion_editar and funcion_editar.semanas == n|add:"0" %}selected{% endif %}>
                                    {{ n }} semana{% if n != '1' %}s{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        {% if funcion_editar %}
                            <small class="text-muted">Actual: {{ funcion_editar.semanas }} semana{{ funcion_editar.semanas|pluralize }}</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Horarios -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Horarios y Salas</h5>
                        {% if not funcion_editar %}
                            <button type="button" class="btn btn-outline-primary btn-sm" id="agregarHorario">
                                <i class="fas fa-plus"></i> Agregar Horario
                            </button>
                        {% endif %}
                    </div>
                    
                    <div id="horariosContainer">
                        <div class="horario-item">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Horario</label>
                                    <select name="horario[]" class="form-select" {% if not funcion_editar %}required{% endif %}>
                                        <option value="">-- Selecciona horario --</option>
                                        {% for h, label in HORARIOS_DISPONIBLES %}
                                            <option value="{{ h }}" {% if funcion_editar and funcion_editar.horario == h %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    {% if funcion_editar %}
                                        <small class="text-muted">Actual: {{ funcion_editar.get_horario_display }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Sala / Formato</label>
                                    <select name="sala[]" class="form-select sala-select" {% if not funcion_editar %}required{% endif %}>
                                        <option value="">-- Selecciona una sala --</option>
                                        {% if funcion_editar %}
                                            {% for sala, formato in funcion_editar.pelicula.get_salas_con_formato %}
                                                <option value="{{ sala }}" {% if funcion_editar.sala == sala %}selected{% endif %}>
                                                    {{ sala }} - {{ formato }}
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    {% if funcion_editar %}
                                        <small class="text-muted">Actual: {{ funcion_editar.sala }} - {{ funcion_editar.get_formato_sala }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    {% if not funcion_editar %}
                                        <button type="button" class="btn btn-outline-danger remove-horario" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        {% if funcion_editar %}
                            <i class="fas fa-info-circle"></i> Editando funci√≥n existente. Deja campos vac√≠os para mantener valores actuales.
                        {% else %}
                            <i class="fas fa-info-circle"></i> Puede agregar m√∫ltiples horarios para la misma pel√≠cula
                        {% endif %}
                    </div>
                </div>

                <div class="mt-4 text-center">
                    {% if funcion_editar %}
                        <button type="submit" class="btn btn-warning px-4"><i class="fas fa-save"></i> Guardar Cambios</button>
                        <a href="{% url 'administrar_funciones' %}" class="btn btn-secondary px-4">Cancelar</a>
                    {% else %}
                        <button type="submit" class="btn btn-success px-4"><i class="fas fa-plus"></i> Agregar Funciones</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- === FUNCIONES VIGENTES === -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-dark text-white">üéûÔ∏è Funciones Vigentes</div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Pel√≠cula</th>
                        <th>Inicio</th>
                        <th>Duraci√≥n</th>
                        <th colspan="2" class="text-center">Horarios, Salas y Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grupo in funciones_actuales_agrupadas %}
                        <tr>
                            <td>
                                {% if grupo.pelicula.imagen_url %}
                                    <img src="{{ grupo.pelicula.imagen_url }}" alt="{{ grupo.pelicula.nombre }}" class="img-thumbnail" style="width:60px; height:80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary text-white text-center img-thumbnail d-flex justify-content-center align-items-center" style="width:60px; height:80px;">
                                        <i class="fas fa-film"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td><strong>{{ grupo.pelicula.nombre }}</strong></td>
                            <td>{{ grupo.fecha_inicio|date:"d/m/Y" }}</td>
                            <td>{{ grupo.funciones.0.semanas }} semana{{ grupo.funciones.0.semanas|pluralize }}</td>
                            <td colspan="2">
                                {% for funcion in grupo.funciones %}
                                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                        <div>
                                            <i class="fas fa-clock text-muted me-1"></i>
                                            {{ funcion.get_horario_display }} - <strong>{{ funcion.sala }}</strong> - {{ funcion.get_formato_sala }}
                                        </div>
                                        <div class="d-flex gap-1">
                                            <a href="?editar={{ funcion.id }}" class="btn btn-warning btn-sm" title="Editar"><i class="fas fa-edit"></i></a>
                                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminar{{ funcion.id }}" title="Eliminar"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-calendar-times fa-2x mb-2"></i><br>No hay funciones vigentes
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- === FUNCIONES PASADAS === -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-secondary text-white">üìú Funciones Pasadas</div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Pel√≠cula</th>
                        <th>Inicio</th>
                        <th>Duraci√≥n</th>
                        <th colspan="2" class="text-center">Horarios, Salas y Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grupo in funciones_pasadas_agrupadas %}
                        <tr>
                            <td>
                                {% if grupo.pelicula.imagen_url %}
                                    <img src="{{ grupo.pelicula.imagen_url }}" alt="{{ grupo.pelicula.nombre }}" class="img-thumbnail" style="width:60px; height:80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary text-white text-center img-thumbnail d-flex justify-content-center align-items-center" style="width:60px; height:80px;">
                                        <i class="fas fa-film"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td><strong>{{ grupo.pelicula.nombre }}</strong></td>
                            <td>{{ grupo.fecha_inicio|date:"d/m/Y" }}</td>
                            <td>{{ grupo.funciones.0.semanas }} semana{{ grupo.funciones.0.semanas|pluralize }}</td>
                            <td colspan="2">
                                {% for funcion in grupo.funciones %}
                                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                        <div>
                                            <i class="fas fa-clock text-muted me-1"></i>
                                            {{ funcion.get_horario_display }} - <strong>{{ funcion.sala }}</strong> - {{ funcion.get_formato_sala }}
                                        </div>
                                        <div>
                                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalReactivar{{ funcion.id }}" title="Reactivar">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminarPermanente{{ funcion.id }}" title="Eliminar Permanentemente">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-history fa-2x mb-2"></i><br>No hay funciones pasadas
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- ============================================ -->
<!-- MODALES DE CONFIRMACI√ìN ELIMINAR -->
<!-- ============================================ -->
{% for grupo in funciones_actuales_agrupadas %}
    {% for funcion in grupo.funciones %}
        <div class="modal fade" id="modalEliminar{{ funcion.id }}" tabindex="-1" aria-labelledby="modalEliminarLabel{{ funcion.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="modalEliminarLabel{{ funcion.id }}">üóëÔ∏è Confirmar Eliminaci√≥n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>¬øEst√°s seguro de eliminar la siguiente funci√≥n?</p>
                        <ul class="list-unstyled">
                            <li><strong>Pel√≠cula:</strong> {{ funcion.pelicula.nombre }}</li>
                            <li><strong>Sala:</strong> {{ funcion.sala }}</li>
                            <li><strong>Horario:</strong> {{ funcion.get_horario_display }}</li>
                            <li><strong>Fecha inicio:</strong> {{ funcion.fecha_inicio|date:"d/m/Y" }}</li>
                            <li><strong>Duraci√≥n:</strong> {{ funcion.semanas }} semana{{ funcion.semanas|pluralize }}</li>
                        </ul>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Esta acci√≥n desactivar√° la funci√≥n y liberar√° todos los horarios asociados.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form method="POST" action="{% url 'administrar_funciones' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="eliminar">
                            <input type="hidden" name="funcion_id" value="{{ funcion.id }}">
                            <button type="submit" class="btn btn-danger">S√≠, eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endfor %}

<!-- ============================================ -->
<!-- MODALES DE CONFIRMACI√ìN REACTIVAR -->
<!-- ============================================ -->
{% for grupo in funciones_pasadas_agrupadas %}
    {% for funcion in grupo.funciones %}
        <div class="modal fade" id="modalReactivar{{ funcion.id }}" tabindex="-1" aria-labelledby="modalReactivarLabel{{ funcion.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="modalReactivarLabel{{ funcion.id }}">üîÑ Confirmar Reactivaci√≥n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>¬øEst√°s seguro de reactivar la siguiente funci√≥n?</p>
                        <ul class="list-unstyled">
                            <li><strong>Pel√≠cula:</strong> {{ funcion.pelicula.nombre }}</li>
                            <li><strong>Sala:</strong> {{ funcion.sala }}</li>
                            <li><strong>Horario:</strong> {{ funcion.get_horario_display }}</li>
                            <li><strong>Fecha inicio original:</strong> {{ funcion.fecha_inicio|date:"d/m/Y" }}</li>
                            <li><strong>Duraci√≥n:</strong> {{ funcion.semanas }} semana{{ funcion.semanas|pluralize }}</li>
                        </ul>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Si la fecha de inicio ya pas√≥, se actualizar√° autom√°ticamente a hoy ({{ hoy_es|date:"d/m/Y" }}).
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form method="POST" action="{% url 'administrar_funciones' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="reactivar">
                            <input type="hidden" name="funcion_id" value="{{ funcion.id }}">
                            <button type="submit" class="btn btn-success">S√≠, reactivar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endfor %}

<!-- ============================================ -->
<!-- MODALES DE CONFIRMACI√ìN ELIMINAR PERMANENTE -->
<!-- ============================================ -->
{% for grupo in funciones_pasadas_agrupadas %}
    {% for funcion in grupo.funciones %}
        <div class="modal fade" id="modalEliminarPermanente{{ funcion.id }}" tabindex="-1" aria-labelledby="modalEliminarPermanenteLabel{{ funcion.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="modalEliminarPermanenteLabel{{ funcion.id }}">‚ö†Ô∏è Eliminar Permanentemente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>¬øEst√°s seguro de eliminar <strong>permanentemente</strong> la siguiente funci√≥n?</p>
                        <ul class="list-unstyled">
                            <li><strong>Pel√≠cula:</strong> {{ funcion.pelicula.nombre }}</li>
                            <li><strong>Sala:</strong> {{ funcion.sala }}</li>
                            <li><strong>Horario:</strong> {{ funcion.get_horario_display }}</li>
                            <li><strong>Fecha inicio:</strong> {{ funcion.fecha_inicio|date:"d/m/Y" }}</li>
                            <li><strong>Duraci√≥n:</strong> {{ funcion.semanas }} semana{{ funcion.semanas|pluralize }}</li>
                        </ul>
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>¬°ADVERTENCIA!</strong> Esta acci√≥n eliminar√° la funci√≥n de forma permanente de la base de datos y no podr√° recuperarse.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form method="POST" action="{% url 'administrar_funciones' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="eliminar_permanente">
                            <input type="hidden" name="funcion_id" value="{{ funcion.id }}">
                            <button type="submit" class="btn btn-danger">S√≠, eliminar permanentemente</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/funciones.js' %}"></script>
</body>
</html>