{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinePlus - Selecci√≥n de Asientos</title>
    <link rel="stylesheet" href="{% static 'styles/asientos.css' %}">
</head>
<body>
    <div class="cine-container">

        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                {% if message.tags == "success" %}
                <div class="success-message">
                    <div class="success-icon">‚úîÔ∏è</div>
                    <div class="success-text">
                        <h2>¬°Reserva Confirmada!</h2>
                        <p>{{ message }}</p>
                        <p class="extra">Tu ticket ha sido enviado a tu correo electr√≥nico üì©</p>
                    </div>
                </div>
                {% else %}
                <div class="message {{ message.tags }}">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <header class="cine-header">
            <h1>CineDot</h1>
            <div class="movie-info">
                <h2>{{ pelicula.nombre }}</h2>
                <p>Director: {{ pelicula.director }}</p>
                <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster-small">
            </div>
        </header>

        <div class="customer-form">
            <a href="{% url 'index' %}" class="btn-back">‚Üê Volver al inicio</a>

            <div class="fecha-info">
                <h3>üìÖ Funci√≥n del {{ fecha_seleccionada|date:"l, d \\d\\e F \\d\\e Y" }}</h3>
            </div>

            <h3>Datos del Cliente</h3>

            <form id="reserva-form" method="POST" action="{% url 'asientos' pelicula.id %}?fecha={{ fecha_seleccionada|date:'Y-m-d' }}">
                {% csrf_token %}

                <div class="form-group">
                    <label for="nombre_cliente">Nombre:</label>
                    <input type="text" id="nombre_cliente" name="nombre_cliente" value="{{ nombre_cliente|default:'' }}" required>
                </div>
                <div class="form-group">
                    <label for="apellido_cliente">Apellido:</label>
                    <input type="text" id="apellido_cliente" name="apellido_cliente" value="{{ apellido_cliente|default:'' }}" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" value="{{ email|default:'' }}" required>
                </div>

                <!-- Cup√≥n -->
                <div class="form-group cupon-section">
                    <label for="codigo_cupon">C√≥digo de Descuento:</label>
                    <div class="cupon-input-group">
                        <input type="text" id="codigo_cupon" name="codigo_cupon" value="{{ codigo_cupon|default:'' }}" placeholder="Ingresa tu c√≥digo">
                        <button type="submit" name="accion" value="recalcular" class="btn-apply">
                            Aplicar Cup√≥n
                        </button>
                    </div>
                    {% if mensaje_cupon %}
                        <p id="cupon-message" style="color: {% if 'v√°lido' in mensaje_cupon or '‚úÖ' in mensaje_cupon %}green{% else %}red{% endif %};">
                            {{ mensaje_cupon }}
                        </p>
                    {% endif %}
                </div>

                <!-- Funciones disponibles -->
                <div class="form-group">
                    <label>Selecciona Horario y Sala:</label>
                    <div class="funciones-container">
                        {% for item in funciones_con_precios %}
                        <label class="funcion-option">
                            <input type="radio"
                                   name="funcion_id"
                                   value="{{ item.funcion.id }}"
                                   data-formato="{{ item.formato }}"
                                   data-precio="{{ item.precio }}"
                                   {% if item.funcion == funcion_actual %}checked{% endif %}
                                   required
                                   class="auto-submit">
                            <div class="funcion-content">
                                <div class="funcion-horario">üïê {{ item.funcion.get_horario_display }}</div>
                                <div class="funcion-sala">üé¨ Sala {{ item.funcion.sala }}</div>
                                <div class="funcion-formato"><strong>{{ item.formato }}</strong> - ${{ item.precio }}</div>
                            </div>
                        </label>
                        {% empty %}
                        <p class="no-funciones-message">No hay funciones disponibles para esta fecha</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Grilla de asientos -->
                <div class="screen-container"><div class="screen">Pantalla</div></div>
                <div class="seats-grid">
                    {% for fila in "ABCDE" %}
                    <div class="seat-row">
                        <span class="row-letter">{{ fila }}</span>
                        {% for numero in "12345678" %}
                        {% with asiento=fila|add:numero %}
                        <label class="seat-label">
                            <input type="checkbox"
                                   name="asientos_list"
                                   value="{{ asiento }}"
                                   {% if asiento in asientos_ocupados %}disabled{% endif %}
                                   {% if asiento in asientos_seleccionados %}checked{% endif %}
                                   class="auto-submit"
                                   style="display: none;">
                            <div class="seat {% if asiento in asientos_ocupados %}reserved{% elif asiento in asientos_seleccionados %}selected{% else %}available{% endif %}">
                                {{ numero }}
                            </div>
                        </label>
                        {% endwith %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>

                <div class="legend">
                    <div class="legend-item"><div class="seat available"></div><span>Disponible</span></div>
                    <div class="legend-item"><div class="seat selected"></div><span>Seleccionado</span></div>
                    <div class="legend-item"><div class="seat reserved"></div><span>Ocupado</span></div>
                </div>

                <!-- Resumen -->
                <div class="selection-summary">
                    <h3>Tu selecci√≥n:</h3>
                    <div class="selected-seats" id="selected-seats">
                        {% if asientos_seleccionados and asientos_seleccionados|length > 0 %}
                            {{ asientos_seleccionados|join:", " }}
                        {% else %}
                            Ning√∫n asiento seleccionado
                        {% endif %}
                    </div>
                    <div class="ticket-counter" id="ticket-counter">
                        <span>Boletos:</span>
                        <span id="ticket-count">{{ cantidad_boletos|default:0 }}</span>
                    </div>

                    <hr>
                    <div class="price-details">
                        <p class="price-row">
                            <span>Formato:</span>
                            <span id="formato-display">{{ formato_actual }}</span>
                        </p>
                        <p class="price-row">
                            <span>Precio por boleto:</span>
                            <span id="precio-boleto-display">${{ precio_funcion_actual|floatformat:2 }}</span>
                        </p>
                        <p class="price-row">
                            <span>Subtotal:</span>
                            <span id="subtotal-display">${{ subtotal|floatformat:2 }}</span>
                        </p>
                        {% if descuento_porcentaje and descuento_porcentaje > 0 %}
                        <p id="discount-row" class="price-row discount-row" style="color: #28a745;">
                            <span>Descuento ({{ descuento_porcentaje }}%):</span>
                            <span>-${{ descuento_monto|floatformat:2 }}</span>
                        </p>
                        {% endif %}
                    </div>
                    <div class="total-price" id="total-price">
                        Total: ${{ total|floatformat:2 }}
                    </div>
                </div>

                <!-- Secci√≥n de M√©todo de Pago - PBI-30 -->
                <div class="payment-section">
                    <h3>üí≥ M√©todo de Pago</h3>
                    
                    <div class="payment-method-selector">
                        <label class="payment-option">
                            <input type="radio" name="usar_metodo_guardado" value="false" checked class="payment-radio">
                            <div class="payment-option-content">
                                <span class="payment-icon">üí≥</span>
                                <span class="payment-label">Pagar con nueva tarjeta</span>
                            </div>
                        </label>
                    </div>

                    <!-- Formulario de nueva tarjeta -->
                    <div id="new-card-form" class="new-card-form">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="numero_tarjeta">N√∫mero de Tarjeta *</label>
                                <div class="card-number-input">
                                    <input type="text" 
                                           id="numero_tarjeta" 
                                           name="numero_tarjeta" 
                                           placeholder="1234 5678 9012 3456"
                                           maxlength="19"
                                           required>
                                    <span class="card-icon" id="card-icon">üí≥</span>
                                </div>
                                <span class="field-error" id="error-numero-tarjeta"></span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombre_titular">Nombre del Titular *</label>
                                <input type="text" 
                                       id="nombre_titular" 
                                       name="nombre_titular" 
                                       placeholder="Como aparece en la tarjeta"
                                       required>
                                <span class="field-error" id="error-nombre-titular"></span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha_expiracion">Fecha de Expiraci√≥n *</label>
                                <input type="text" 
                                       id="fecha_expiracion" 
                                       name="fecha_expiracion" 
                                       placeholder="MM/YY"
                                       maxlength="5"
                                       required>
                                <span class="field-error" id="error-fecha-expiracion"></span>
                            </div>

                            <div class="form-group">
                                <label for="cvv">CVV *</label>
                                <input type="text" 
                                       id="cvv" 
                                       name="cvv" 
                                       placeholder="123"
                                       maxlength="4"
                                       required>
                                <span class="field-error" id="error-cvv"></span>
                            </div>
                        </div>

                        {% if user.is_authenticated %}
                        <div class="save-card-option">
                            <label class="checkbox-label">
                                <input type="checkbox" name="guardar_tarjeta" id="guardar_tarjeta">
                                <span>üíæ Guardar esta tarjeta para futuras compras</span>
                            </label>
                        </div>
                        {% else %}
                        <div class="login-suggestion">
                            <p>üí° <a href="{% url 'login' %}?next={{ request.path }}">Inicia sesi√≥n</a> para guardar tus m√©todos de pago</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="payment-security-note">
                        <small>üîí Tu informaci√≥n est√° protegida. Este es un sistema de simulaci√≥n - no se procesar√°n cargos reales.</small>
                    </div>
                </div>

                <!-- Bot√≥n de confirmaci√≥n y pago -->
                <div class="confirm-payment-section">
                    <button type="submit" name="accion" value="reservar" class="btn-confirm-payment" id="btn-confirm-payment">
                        <span class="btn-icon">üéüÔ∏è</span>
                        <span class="btn-text">Confirmar Reserva y Pagar</span>
                        <span class="btn-amount">${{ total|floatformat:2 }}</span>
                    </button>
                    <div class="processing-indicator" id="processing-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <span>Procesando pago, por favor espera...</span>
                    </div>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" name="fecha" value="{{ fecha_seleccionada|date:'Y-m-d' }}">
            </form>
        </div>

        {% if messages and codigo_reserva %}
        <a id="auto-download" href="{% url 'descargar_ticket' codigo_reserva %}" download style="display:none;"></a>
        <script>
            document.getElementById("auto-download").click();
        </script>
        {% endif %}
    </div>

    <script src="{% static 'js/asientos.js' %}"></script>
</body>
</html>