{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinePlus - Selección de Asientos</title>
    <link rel="stylesheet" href="{% static 'styles/asientos.css' %}">
</head>
<body>
    <div class="cine-container">
        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <header class="cine-header">
            <h1>CineDot</h1>
            <div class="movie-info">
                <h2>{{ pelicula.nombre }}</h2>
                <p>Director: {{ pelicula.director }}</p>
                <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster-small">
            </div>
        </header>

        <!-- Formulario -->
        <div class="customer-form">
            <!-- Botón de regreso -->
            <a href="{% url 'index' %}" class="btn-back">← Volver al inicio</a>

            <h3>Datos del Cliente</h3>
            <form id="reserva-form" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="nombre_cliente">Nombre:</label>
                    <input type="text" id="nombre_cliente" name="nombre_cliente" required>
                </div>
                <div class="form-group">
                    <label for="apellido_cliente">Apellido:</label>
                    <input type="text" id="apellido_cliente" name="apellido_cliente" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <!-- Formato -->
                <div class="form-group">
                    <label>Formato:</label>
                    <div class="format-options">
                        {% for value, label in formatos %}
                        <label class="format-option">
                            <input type="radio" name="formato" value="{{ value }}" {% if forloop.first %}checked{% endif %}>
                            {{ label }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Combo único -->
                <div class="form-group">
                    <label for="combo">Horario y Sala:</label>
                    <select id="combo" name="combo" required onchange="actualizarAsientos()">
                        {% for c in combinaciones %}
                        <option value="{{ c }}" {% if c == combo_actual %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>

                <input type="hidden" id="asientos" name="asientos" value="">
            </form>
        </div>

        <div class="screen-container">
            <div class="screen">Pantalla</div>
        </div>

        <div class="seats-container">
            <div class="seats-grid">
                {% for fila in "ABCDE" %}
                <div class="seat-row">
                    <span class="row-letter">{{ fila }}</span>
                    {% for numero in "12345678" %}
                    {% with asiento=fila|add:numero %}
                    <div class="seat {% if asiento in asientos_ocupados %}reserved{% else %}available{% endif %}" 
                         data-seat="{{ asiento }}">
                         {{ numero }}
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="seat available"></div><span>Disponible</span></div>
            <div class="legend-item"><div class="seat selected"></div><span>Seleccionado</span></div>
            <div class="legend-item"><div class="seat reserved"></div><span>Ocupado</span></div>
        </div>

        <div class="selection-summary">
            <h3>Tu selección:</h3>
            <div class="selected-seats" id="selected-seats">Ningún asiento seleccionado</div>
            <div class="total-price" id="total-price">Total: $0</div>
            <div class="ticket-counter" id="ticket-counter">
                <span>Boletos:</span>
                <span id="ticket-count">0</span>
            </div>
            <button type="submit" form="reserva-form" class="btn-confirm">Confirmar Reserva</button>
        </div>
    </div>

    <script>
        let selectedSeats = [];
        const precioBase = 3.50;
        const STORAGE_KEY = 'formData_{{ pelicula.id }}';
        const SCROLL_KEY = 'scrollPos_{{ pelicula.id }}';
        const limpiarForm = {{ limpiar_form|yesno:"true,false" }};

        function updateSummary() {
            const selectedSeatsElement = document.getElementById('selected-seats');
            const ticketCountElement = document.getElementById('ticket-count');
            const totalPriceElement = document.getElementById('total-price');
            const asientosInput = document.getElementById('asientos');

            selectedSeatsElement.textContent = selectedSeats.length > 0 ? selectedSeats.join(', ') : 'Ningún asiento seleccionado';
            ticketCountElement.textContent = selectedSeats.length;

            const formatoSeleccionado = document.querySelector('input[name="formato"]:checked').value;
            let precioPorBoleto = precioBase;
            if (formatoSeleccionado === '3D') precioPorBoleto = 4.50;
            if (formatoSeleccionado === 'IMAX') precioPorBoleto = 6.00;

            totalPriceElement.textContent = `Total: $${(selectedSeats.length * precioPorBoleto).toFixed(2)}`;
            asientosInput.value = selectedSeats.join(',');
        }

        function actualizarAsientos() {
            const combo = document.getElementById('combo').value;
            const formData = {};
            document.querySelectorAll('#reserva-form input, #reserva-form select').forEach(el => {
                if (el.type === 'radio') {
                    if (el.checked) formData[el.name] = el.value;
                } else {
                    formData[el.name] = el.value;
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
            localStorage.setItem(SCROLL_KEY, window.scrollY);
            window.location.href = `?combo=${encodeURIComponent(combo)}`;
        }

        window.addEventListener('load', () => {
            if (limpiarForm) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(SCROLL_KEY);
            } else {
                const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                for (const name in savedData) {
                    const el = document.querySelector(`[name="${name}"]`);
                    if (el) {
                        if (el.type === 'radio') {
                            if (el.value === savedData[name]) el.checked = true;
                        } else {
                            el.value = savedData[name];
                        }
                    }
                }
                const scrollPos = localStorage.getItem(SCROLL_KEY);
                if (scrollPos) {
                    window.scrollTo(0, parseInt(scrollPos));
                    localStorage.removeItem(SCROLL_KEY);
                }
            }
        });

        document.querySelectorAll('.seat.available').forEach(seat => {
            seat.addEventListener('click', () => {
                const seatNumber = seat.getAttribute('data-seat');
                if (seat.classList.contains('selected')) {
                    seat.classList.remove('selected');
                    selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                } else {
                    seat.classList.add('selected');
                    selectedSeats.push(seatNumber);
                }
                updateSummary();
            });
        });

        document.querySelectorAll('input[name="formato"]').forEach(radio => {
            radio.addEventListener('change', updateSummary);
        });

        updateSummary();
    </script>
</body>
</html>