{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinePlus - Selecci√≥n de Asientos</title>
    <link rel="stylesheet" href="{% static 'styles/asientos.css' %}">
</head>
<body>
    <div class="cine-container">
   
        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                {% if message.tags == "success" %}
                <div class="success-message">
                    <div class="success-icon">‚úîÔ∏è</div>
                    <div class="success-text">
                        <h2>¬°Reserva Confirmada!</h2>
                        <p>{{ message }}</p>
                        <p class="extra">Tu ticket ha sido enviado a tu correo electr√≥nico üì©</p>
                    </div>
                </div>
                {% else %}
                <div class="message {{ message.tags }}">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <header class="cine-header">
            <h1>CineDot</h1>
            <div class="movie-info">
                <h2>{{ pelicula.nombre }}</h2>
                <p>Director: {{ pelicula.director }}</p>
                <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster-small">
            </div>
        </header>

        <!-- Formulario -->
        <div class="customer-form">
            <!-- Bot√≥n de regreso -->
            <a href="{% url 'index' %}" class="btn-back">‚Üê Volver al inicio</a>

            <h3>Datos del Cliente</h3>
            <form id="reserva-form" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="nombre_cliente">Nombre:</label>
                    <input type="text" id="nombre_cliente" name="nombre_cliente" required>
                </div>
                <div class="form-group">
                    <label for="apellido_cliente">Apellido:</label>
                    <input type="text" id="apellido_cliente" name="apellido_cliente" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group cupon-section" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <label for="codigo_cupon" style="font-weight: bold;">C√≥digo de Descuento:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="codigo_cupon" placeholder="Ingresa tu c√≥digo" style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 3px;">
                        <button type="button" id="btn-aplicar-cupon" class="btn-apply" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Aplicar
                        </button>
                    </div>
                    
                    <p id="cupon-message" style="margin-top: 5px; font-weight: bold; font-size: 0.9em;">
                        {% if mensaje_cupon %}
                            <script>document.getElementById('cupon-message').style.color = 'green';</script>
                        {% endif %}
                        {{ mensaje_cupon }}
                    </p>
                    
                    <input type="hidden" id="descuento_porcentaje_actual" value="{{ descuento_porcentaje|default:0 }}">
                </div>

                <!-- Formato -->
                <div class="form-group">
                    <label>Formato:</label>
                    <div class="format-options">
                        {% for value, label in formatos %}
                        <label class="format-option">
                            <input type="radio" name="formato" value="{{ value }}" {% if forloop.first %}checked{% endif %}>
                            {{ label }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Combo √∫nico -->
                <div class="form-group">
                    <label for="combo">Horario y Sala:</label>
                    <select id="combo" name="combo" required>
                        {% for c in combinaciones %}
                        <option value="{{ c }}" {% if c == combo_actual %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>

                <input type="hidden" id="asientos" name="asientos" value="">
            </form>
        </div>


        <div class="screen-container"><div class="screen">Pantalla</div></div>
            <div class="seats-grid">
                {% for fila in "ABCDE" %}
                <div class="seat-row">
                    <span class="row-letter">{{ fila }}</span>
                    {% for numero in "12345678" %}
                    {% with asiento=fila|add:numero %}
                    <div class="seat {% if asiento in asientos_ocupados %}reserved{% else %}available{% endif %}" 
                         data-seat="{{ asiento }}">
                         {{ numero }}
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="seat available"></div><span>Disponible</span></div>
            <div class="legend-item"><div class="seat selected"></div><span>Seleccionado</span></div>
            <div class="legend-item"><div class="seat reserved"></div><span>Ocupado</span></div>
        </div>

        <div class="selection-summary">
            <h3>Tu selecci√≥n:</h3>
            <div class="selected-seats" id="selected-seats">Ning√∫n asiento seleccionado</div>
            <div class="ticket-counter" id="ticket-counter">
                <span>Boletos:</span>
                <span id="ticket-count">0</span>
            </div>

            <hr style="margin: 10px 0;">
            <div class="price-details" style="font-size: 1em;">
                <p style="display: flex; justify-content: space-between;">Subtotal: <span id="subtotal-display">$0.00</span></p>
                <p id="discount-row" style="color: green; display: flex; justify-content: space-between;">
                    Descuento (<span id="discount-percent-display">0</span>%): <span id="discount-amount-display">-$0.00</span>
                </p>
            </div>
            <div class="total-price" id="total-price" style="font-size: 1.5em; font-weight: bold; margin-top: 10px; border-top: 2px solid #333; padding-top: 5px;">
                Total: $0.00
            </div>
            <button type="submit" form="reserva-form" class="btn-confirm">Confirmar Reserva</button>
        </div>
    </div>

{% if messages and codigo_reserva %}
<a id="auto-download" href="{% url 'descargar_ticket' codigo_reserva %}" download style="display:none;"></a>
<script>
    document.getElementById("auto-download").click();
</script>
{% endif %}

    <!-- Variables globales para pasar datos de Django al JS -->
    <script>
        const PELICULA_ID = {{ pelicula.id }};
        const LIMPIAR_FORM = {{ limpiar_form|yesno:"true,false" }};
        const APLICAR_DESCUENTO_URL = "{% url 'aplicar_descuento_ajax' %}";
        const ASIENTOS_URL = "{% url 'asientos' pelicula.id %}";
    </script>

    <script src="{% static 'js/asientos.js' %}"></script>
</body>
</html>