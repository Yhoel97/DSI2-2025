{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineDot - Cartelera</title>
    <link rel="stylesheet" href="{% static 'styles/index.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<header class="header">
  <div class="header-top">
    <div class="logo-container">
      <a href="/">
        <img src="{% static 'imagenes/cine.png' %}" alt="CineDot Logo" class="logo-img">
      </a>
    </div>
    <div class="nav-container">
  <nav class="nav">
    <ul class="nav-list flex">
      <li><a href="#cartelera"><i class="fas fa-film"></i> Cartelera</a></li>
      <li><a href="#contacto"><i class="fas fa-envelope"></i> Contacto</a></li>
      
      <!-- üé¨ Bot√≥n de Horarios - SIEMPRE VISIBLE -->
      <li>
        <a href="{% url 'horarios_por_pelicula' %}" class="btn btn-outline-info">
          <i class="fas fa-clock"></i> Ver Horarios
        </a>
      </li>

      <!-- üîç Bot√≥n de Filtrar - SIEMPRE VISIBLE -->
      <li>
        <a href="{% url 'filtrar_peliculas' %}" class="btn filter-btn">
          <i class="fas fa-search"></i> Filtrar Pel√≠culas
        </a>
      </li>

      {% if user.is_authenticated %}
        {% if user.is_staff %}
          <li><a href="{% url 'peliculas' %}" class="btn admin-btn"><i class="fas fa-cog"></i> Panel Admin</a></li>
          <li><a href="{% url 'registrar_cupon' %}" class="btn logout-btn"><i class="fas fa-ticket-alt"></i> Cupones</a></li>
        {% endif %}
        <li><a href="{% url 'mis_reservaciones_cancelables' %}" class="btn logout-btn"><i class="fas fa-times-circle"></i> Cancelar Reservas</a></li>
        <li><a href="{% url 'my_logout' %}" class="btn logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a></li>
      {% else %}
        <li><a href="{% url 'login' %}" class="btn login-btn"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n</a></li>
        <li><a href="{% url 'registro' %}" class="btn register-btn"><i class="fas fa-user-plus"></i> Registrarse</a></li>
      {% endif %}
    </ul>
  </nav>

  {% if user.is_authenticated %}
    <div class="user-welcome-wrapper">
      <span class="user-welcome">¬°Hola, {{ user.username }}!</span>
    </div>
  {% endif %}
</div>

</header>

<main>
<!-- üóìÔ∏è Selector de Fecha MEJORADO -->
<section class="section container">
    <div class="date-selector-new">
        <h3 class="date-selector-title-new" id="date-title">
            <i class="fas fa-calendar-week"></i> 
            Cartelera {% if fecha_seleccionada == hoy %}Hoy{% else %}del{% endif %} {{ fecha_formateada }}
        </h3>
        
        <form method="GET" action="{% url 'index' %}" class="date-form-new" id="date-form">
            <select name="fecha" class="date-dropdown-new" id="date-selector">
                {% for dia in dias_disponibles %}
                    <option value="{{ dia.fecha|date:'Y-m-d' }}" 
                            {% if dia.fecha == fecha_seleccionada %}selected{% endif %}>
                        {% if dia.fecha == hoy %}
                            üé¨ Hoy - {{ dia.nombre_es }} {{ dia.fecha|date:"d/m" }}
                        {% else %}
                            {{ dia.nombre_es }} {{ dia.fecha|date:"d/m" }}
                        {% endif %}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>
</section>

    {% if es_admin %}
    <!-- üé• Secci√≥n solo para administradores - TODAS LAS PEL√çCULAS -->
    <section id="base-datos" class="section container">
        <h2 class="section-title">üé• Pel√≠culas en Base de Datos</h2>
        <p class="text-muted text-center mb-3">
            <i class="fas fa-info-circle"></i> 
            Vista completa de todas las pel√≠culas registradas en el sistema
        </p>
        <div class="peliculas-grid grid">
            {% for pelicula in peliculas_base_datos %}
            <div class="pelicula-card">
                <div class="poster-container">
                    <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster responsive-img">
                </div>

                <div class="pelicula-info">
                    <h3 class="movie-title">{{ pelicula.nombre }}</h3>

                    <div class="movie-details">
                        <p><span class="detail-label">G√©nero:</span> {{ pelicula.get_generos_list|join:", " }}</p>
                        <p><span class="detail-label">Director:</span> {{ pelicula.director }}</p>
                        <p><span class="detail-label">Clasificaci√≥n:</span> {{ pelicula.get_clasificacion_display }}</p>
                        <p><span class="detail-label">Idioma:</span> {{ pelicula.get_idioma_display }}</p>
                        <p><span class="detail-label">A√±o:</span> {{ pelicula.anio }}</p>

                        <!-- ‚úÖ Estado de funciones - Solo mostrar si NO tiene funciones -->
                        {% if not pelicula.tiene_funciones %}
                        <div class="horarios-container">
                            <span class="detail-label text-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Esta pel√≠cula no tiene funciones asignadas
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- ‚≠ê Rating -->
                    <div class="movie-rating">
                        <div class="rating-stars">
                            {% with estrellas=pelicula.get_rating_estrellas %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= estrellas.llenas %}
                                        <i class="fas fa-star star-filled"></i>
                                    {% elif forloop.counter == estrellas.llenas|add:1 and estrellas.media %}
                                        <i class="fas fa-star-half-alt star-filled"></i>
                                    {% else %}
                                        <i class="far fa-star star-empty"></i>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </div>
                        <div class="rating-info">
                            <span class="rating-score">{{ pelicula.get_rating_promedio }}/5</span>
                            <span class="rating-count">({{ pelicula.get_total_valoraciones }} valoraci√≥n{{ pelicula.get_total_valoraciones|pluralize:"es" }})</span>
                        </div>
                    </div>

                    <div class="movie-actions flex">
                        <a href="{{ pelicula.trailer_url }}" target="_blank" class="btn trailer-btn">
                            <i class="fab fa-youtube"></i> Ver Tr√°iler
                        </a>
                        <a href="{% url 'pelicula_detalle' pelicula.id %}" class="btn review-btn">
                            <i class="fas fa-star"></i> Ver Rese√±as
                        </a>
                        <a href="{% url 'administrar_funciones' %}" class="btn buy-btn">
                            <i class="fas fa-plus-circle"></i> Agregar Funci√≥n
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <p style="text-align:center; color:#555;">
                <i class="fas fa-inbox"></i> 
                No hay pel√≠culas registradas en la base de datos.
            </p>
            {% endfor %}
        </div>
    </section>
    {% endif %}


    <!-- üéûÔ∏è Pel√≠culas en Cartelera -->
    <section id="cartelera" class="section container">
        <h2 class="section-title">
            üéûÔ∏è Pel√≠culas en Cartelera {% if fecha_seleccionada == hoy %}Hoy{% else %}del{% endif %} {{ fecha_formateada }}
        </h2>

        <div class="peliculas-grid grid">
            {% for pelicula in peliculas_cartelera %}
            <div class="pelicula-card">
                <div class="poster-container">
                    <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster responsive-img">
                </div>

                <div class="pelicula-info">
                    <h3 class="movie-title">{{ pelicula.nombre }}</h3>

                    <div class="movie-details">
                        <p><span class="detail-label">G√©nero:</span> {{ pelicula.get_generos_list|join:", " }}</p>
                        <p><span class="detail-label">Director:</span> {{ pelicula.director }}</p>
                        <p><span class="detail-label">Clasificaci√≥n:</span> {{ pelicula.get_clasificacion_display }}</p>
                        <p><span class="detail-label">Idioma:</span> {{ pelicula.get_idioma_display }}</p>
                        <p><span class="detail-label">A√±o:</span> {{ pelicula.anio }}</p>

                        <!-- ‚úÖ Horarios en formato de rengl√≥n uno abajo del otro -->
                        <div class="horarios-container">
                            <span class="detail-label">Horarios disponibles:</span>
                            <div class="horarios-list">
                                {% for funcion in pelicula.funciones_del_dia %}
                                    <div class="horario-item">
                                        <i class="fas fa-clock"></i> 
                                        {{ funcion.get_horario_display }} - 
                                        {{ funcion.sala }} - 
                                        {{ funcion.get_formato_sala }}
                                    </div>
                                {% empty %}
                                    <span class="text-muted">No hay horarios disponibles</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- ‚≠ê Rating -->
                    <div class="movie-rating">
                        <div class="rating-stars">
                            {% with estrellas=pelicula.get_rating_estrellas %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= estrellas.llenas %}
                                        <i class="fas fa-star star-filled"></i>
                                    {% elif forloop.counter == estrellas.llenas|add:1 and estrellas.media %}
                                        <i class="fas fa-star-half-alt star-filled"></i>
                                    {% else %}
                                        <i class="far fa-star star-empty"></i>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </div>
                        <div class="rating-info">
                            <span class="rating-score">{{ pelicula.get_rating_promedio }}/5</span>
                            <span class="rating-count">({{ pelicula.get_total_valoraciones }} valoraci√≥n{{ pelicula.get_total_valoraciones|pluralize:"es" }})</span>
                        </div>
                    </div>

                    <!-- üé¨ Acciones -->
                    <div class="movie-actions flex">
                        <a href="{{ pelicula.trailer_url }}" target="_blank" class="btn trailer-btn">
                            <i class="fab fa-youtube"></i> Ver Tr√°iler
                        </a>
                        <a href="{% url 'pelicula_detalle' pelicula.id %}" class="btn review-btn">
                            <i class="fas fa-star"></i> Ver Rese√±as
                        </a>
                        <a href="{% url 'asientos' pelicula.id %}?fecha={{ fecha_seleccionada|date:'Y-m-d' }}" 
                           class="btn buy-btn">
                            <i class="fas fa-ticket-alt"></i> Comprar Boletos
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-funciones">
                <i class="fas fa-film fa-3x"></i>
                <p>No hay funciones programadas para esta fecha.</p>
                {% if fecha_seleccionada != hoy %}
                    <a href="{% url 'index' %}" class="btn btn-primary">Ver Cartelera de Hoy</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- üé¨ Pr√≥ximamente -->
    <section id="proximas" class="section container">
        <h2 class="section-title">üé¨ Pr√≥ximamente</h2>
        <div class="peliculas-grid grid">
            {% for pelicula in peliculas_proximas %}
            <div class="pelicula-card">
                <div class="poster-container">
                    <img src="{{ pelicula.imagen_url }}" alt="{{ pelicula.nombre }}" class="movie-poster responsive-img">
                </div>
                <div class="pelicula-info">
                    <h3 class="movie-title">{{ pelicula.nombre }}</h3>
                    <div class="movie-details">
                        <p><span class="detail-label">G√©nero:</span> {{ pelicula.get_generos_list|join:", " }}</p>
                        <p><span class="detail-label">Director:</span> {{ pelicula.director }}</p>
                        <p><span class="detail-label">Fecha de Estreno:</span> {{ pelicula.fecha_estreno|date:"d/m/Y" }}</p>
                    </div>
                    <div class="movie-actions flex">
                        <a href="{{ pelicula.trailer_url }}" target="_blank" class="btn trailer-btn">
                            <i class="fab fa-youtube"></i> Ver Tr√°iler
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <p style="text-align:center; color:#555;">No hay pel√≠culas pr√≥ximas por el momento.</p>
            {% endfor %}
        </div>
    </section>

    <!-- üìû Contacto -->
    <section id="contacto" class="section container">
        <h2 class="section-title">Contacto</h2>
        <div class="contacto-info">
            <p><i class="icono fas fa-envelope"></i> contacto@cinedot.com</p>
            <p><i class="icono fas fa-phone"></i> +503 1234-5678</p>
            <p><i class="icono fas fa-map-marker-alt"></i> Av. Principal #123, San Salvador</p>
        </div>
    </section>
</main>

<footer class="footer">
    <p>¬© 2025 CineDot. Todos los derechos reservados.</p>
</footer>

<script src="{% static 'js/index.js' %}"></script>
</body>
</html>