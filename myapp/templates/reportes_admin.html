{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Reportes Administrativos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles/reportes.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- Encabezado -->
<header>
    <h2><i class="fas fa-chart-line me-2 text-success"></i> Reportes Administrativos</h2>
    <a href="{% url 'index' %}" class="btn-home mt-3">
        <i class="fas fa-home me-2"></i> Volver al inicio
    </a>
</header>

<!-- Contenido principal -->
<div class="container mb-5 mt-4">
    <!-- Formulario de filtros -->
    <form method="GET" class="row g-3 mb-4">
        <div class="col-md-3">
            <label for="pelicula" class="form-label">Pel√≠cula</label>
            <select name="pelicula" id="pelicula" class="form-select">
                <option value="">Todas</option>
                {% for p in peliculas %}
                    <option value="{{ p.id }}" {% if p.id|stringformat:"s" == request.GET.pelicula %}selected{% endif %}>{{ p.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="fecha_inicio" class="form-label">Desde</label>
            <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" value="{{ request.GET.fecha_inicio }}">
        </div>

        <div class="col-md-3">
            <label for="fecha_fin" class="form-label">Hasta</label>
            <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" value="{{ request.GET.fecha_fin }}">
        </div>

        <div class="col-md-12 text-center mt-4">
            <button type="submit" class="btn-filtrar me-2">
                <i class="fas fa-filter me-1"></i> Filtrar
            </button>

            <a href="#" id="btn-limpiar" class="btn-limpiar me-2">
              <i class="fas fa-broom me-1"></i> Limpiar Filtro
            </a>

            <a href="{% url 'exportar_pdf' %}" class="btn-pdf me-2">
                 <i class="fas fa-file-pdf me-1"></i> Exportar PDF
            </a>

            <a href="{% url 'exportar_excel' %}" class="btn-excel">
                <i class="fas fa-file-excel me-1"></i> Exportar Excel
            </a>
        </div>
    </form>

<table class="table table-bordered table-striped text-center align-middle">
  <thead class="table-dark">
    <tr>
      <th>Pel√≠cula</th>
      <th>Fecha</th>
      <th>Boletos por formato</th>
      <th>Total boletos</th>
      <th>Total ($)</th>
    </tr>
  </thead>
  <tbody>
  {% for v in ventas_resumen %}
  <tr>
    <td>{{ v.pelicula__nombre }}</td>
    <td>{{ v.fecha|date:"d/m/Y" }}</td>
    <td>
      {% if formatos_info.v.fecha %}
        {% for f in formatos_info.v.fecha %}
          {{ f.formato }}: {{ f.boletos }}
          {% if not forloop.last %}<br>{% endif %}
        {% endfor %}
      {% else %}
        Sin formato
      {% endif %}
    </td>
    <td>{{ v.total_boletos }}</td>
    <td>${{ v.total_venta|floatformat:2 }}</td>
  </tr>
  {% endfor %}
  <tr class="table-dark">
    <th colspan="3">Totales</th>
    <th>{{ resumen_general.total_boletos|default:0 }}</th>
    <th>${{ resumen_general.total_ventas|floatformat:2 }}</th>
  </tr>
</tbody>
</table>


    <!-- Popularidad -->
    <div class="summary-box">
        <h5><i class="fas fa-fire me-2 text-warning"></i> Pel√≠culas m√°s populares</h5>
        {% if popularidad %}
            <ul>
                {% for p in popularidad %}
                    <li>{{ p.pelicula__nombre }} ‚Äî {{ p.total_boletos }} boletos vendidos</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No hay datos disponibles.</p>
        {% endif %}
    </div>

    <!-- Resumen -->
    <div class="summary-box">
        <h5><i class="fas fa-chart-pie me-2 text-success"></i> Resumen</h5>
        <p><strong>Total de boletos vendidos:</strong> {{ resumen_general.total_boletos|default:0 }}</p>
        <p><strong>Total de ingresos:</strong> ${{ resumen_general.total_ventas|default:0 }}</p>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const limpiarBtn = document.getElementById("btn-limpiar");

    if (limpiarBtn) {
        limpiarBtn.addEventListener("click", function(e) {
            e.preventDefault();

            // 1Ô∏è‚É£ Limpia todos los inputs y selects del formulario
            const form = limpiarBtn.closest("form");
            form.querySelectorAll("input, select").forEach(el => {
                if (el.type === "date" || el.type === "text" || el.tagName === "SELECT") {
                    el.value = "";
                }
            });

            // 2Ô∏è‚É£ Quita los par√°metros de la URL (deja la ruta limpia /reportes/)
            const baseUrl = window.location.origin + window.location.pathname;

            // 3Ô∏è‚É£ Redirige sin par√°metros
            window.location.href = baseUrl;
        });
    }
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

